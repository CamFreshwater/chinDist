---
title: "Predicted composition using CWT and TMB data"
output: html_document
---

```{r import_data, include=FALSE}
library(tidyverse)
library(TMB)
library(ggplot2)

# month range constrained to focal harvest period (reduces in-filling impacts)
month_range = c(seq(3, 6, by = 1), seq(8, 10, by = 1))

catch <- readRDS(here::here("data", "gsiCatchData", "commTroll",
                            "dailyCatch_WCVI.rds")) %>% 
  mutate(reg = factor(catchReg),
         area = as.factor(area),
         month_n = as.numeric(month),
         month = as.factor(month_n),
         year = as.factor(year)
  ) %>% 
  filter(!is.na(cpue),
         #first constrain by range
         month_n %in% c(month_range)
  ) %>% 
  droplevels() %>% 
  mutate(eff_z = as.numeric(scale(boatDays)),
         eff_z2 = eff_z^2
  ) %>% 
  arrange(catchReg, area, month)

comp_gsi <- readRDS(here::here("data", "gsiCatchData", "commTroll",
                           "pstAggRollUpCatchProb.RDS")) %>% 
  rename(regName = pstName) %>%
  #remove northern samples for now due to small sample size
  filter(!regName == "NBC_SEAK")
comp_cwt <- readRDS(here::here("data", "gsiCatchData", "commTroll",
                           "cwt_recovery_clean.rds")) %>% 
  rename(regName = pst_agg) %>% 
  filter(!regName == "NBC_SEAK")

source(here::here("R", "functions", "clean_composition_dat.R"))
comp_gsi_list <- clean_comp(comp_gsi, month_range = month_range, 
                         check_tables = TRUE)
comp_cwt_list <- clean_comp(comp_cwt, month_range = month_range, 
                         check_tables = TRUE)
comp_cwt_list$tables
```

Here are preliminary results of the model that uses commerical catch/effort and genetics data to predict stock-specific abundance of Chinook salmon. Abundance is modeled using a negative binomial distribution with effort (boat days) included as an offset and stock composition is modeled using a multinomial distribution. We generate predictions for strata (catch region or statistical area and month or season) because finer scale spatio-temporal data are unavailable. Sampling (run) years are treated as random intercepts. General predictions are shown in wcvi_prelim_model_nb.Rmd, but the goal here is to contrast estimates using the same model with composition estimates derived from either GSI data or CWT returns.

The relative availability of samples is strongly seasonal and more variable for RMIS samples than GSI data. However the absolute abundance is similar. Note that these are data after infilling has occurred for very rare stocks that weren't sampled in certain months (necessary for multinomial component of the model to converge). 

```{r sample_dist, echo=FALSE, fig.cap = "Monthly GSI and CWT samples available from WCVI troll fisheries."}
comp_g_infill <- comp_gsi_list$long_data %>% 
  group_by(catchReg, month, regName) %>% 
  summarize(n = length(unique(id)),
         dat = "GSI")

comp_c_infill <- comp_cwt_list$long_data %>% 
  group_by(catchReg, month, regName) %>% 
  summarize(n = length(unique(id)),
         dat = "CWT")

rbind(comp_c_infill, comp_g_infill) %>% 
  rename(Stock = regName) %>% 
  ggplot(.) +
  geom_bar(aes(x = month, y = n, fill = Stock), 
           stat = "identity") +
  labs(y = "total samples") +
  facet_wrap(dat ~ catchReg) +
  scale_fill_viridis_d() +
  ggsidekick::theme_sleek()
```

Compare predicted encounter probabilities generated by each dataset in each region for a subset of stocks.

```{r run_models, message=FALSE, warning=FALSE, include=FALSE}
# run model with each set of genetics data if data are missing
combo_list <- readRDS(here::here("generatedData", "model_fits",
                                 "nbmult_cwt_gsi_comp.rds"))
if (!exists("combo_list")) {
  comp_list <- list(comp_gsi_list, comp_cwt_list)
  out_list <- map(comp_list, function(x) {
    comp_wide <- x[["data"]]
    comp_trim <- x[["long_data"]]
    
    fac_dat <- comp_wide %>%
      mutate(facs = as.factor(paste(as.character(catchReg),
                                    as.character(month), sep = "_")),
             facs = fct_relevel(facs, "NWVI_1", "NWVI_2", "NWVI_3", "NWVI_4",
                                "NWVI_5", "NWVI_6",  "NWVI_7", "NWVI_8", "NWVI_9",
                                "NWVI_10", "NWVI_11", "NWVI_12", "SWVI_1",
                                "SWVI_2", "SWVI_3",  "SWVI_4", "SWVI_5", "SWVI_6",
                                "SWVI_7", "SWVI_8",  "SWVI_9", "SWVI_10",
                                "SWVI_11", "SWVI_12"),
             facs_n = as.numeric(facs) - 1) %>%
      select(catchReg, month, facs, facs_n)
    fac_key_eff <- fac_dat %>%
      distinct() %>%
      arrange(facs_n) %>%
      mutate(eff_z = mean(catch$eff_z),
             eff_z2 = mean(catch$eff_z2))
  
    #prep data
    source(here::here("R", "functions", "prep_tmb_dat.R"))
    inputs <- tmb_dat(catch, comp_wide, fac_dat, fac_key = fac_key_eff,
                      mod = "nb")
  
    #run model
    compile(here::here("R", "southCoast", "tmb", "nb_multinomial_1re.cpp"))
    dyn.load(dynlib(here::here("R", "southCoast", "tmb",
                               "nb_multinomial_1re")))
    obj <- MakeADFun(inputs$data, inputs$parameters, random = c("z1_k", "z2_k"),
                     DLL = "nb_multinomial_1re")
  
    opt <- nlminb(obj$par, obj$fn, obj$gr)
    sdr <- sdreport(obj)
    ssdr <- summary(sdr)
  
    #generate predictions
    log_pred <- ssdr[rownames(ssdr) %in% "log_pred_abund", ]
    logit_probs <- ssdr[rownames(ssdr) %in% "logit_pred_prob", ]
    pred_abund <- ssdr[rownames(ssdr) %in% "pred_abund_mg", ]
  
    n_groups <- length(unique(comp_trim$regName))
    n_facs <- length(unique(fac_key_eff$facs_n))
  
    pred_ci <- data.frame(stock = as.character(rep(unique(comp_trim$regName),
                                                   each = n_facs)),
                          logit_prob_est = logit_probs[ , "Estimate"],
                          logit_prob_se =  logit_probs[ , "Std. Error"]) %>%
      mutate(facs_n = rep(fac_key_eff$facs_n, times = n_groups)) %>%
      mutate(pred_prob = plogis(logit_prob_est),
             pred_prob_low = plogis(logit_prob_est +
                                      (qnorm(0.025) * logit_prob_se)),
             pred_prob_up = plogis(logit_prob_est +
                                     (qnorm(0.975) * logit_prob_se)),
             abund_est = pred_abund[ , "Estimate"],
             abund_se =  pred_abund[ , "Std. Error"],
             abund_low = abund_est + (qnorm(0.025) * abund_se),
             abund_up = abund_est + (qnorm(0.975) * abund_se)) %>%
      left_join(., fac_key_eff, by = c("facs_n"))
  
      raw_prop <- comp_trim %>%
        group_by(catchReg, month, year, regName) %>%
        summarize(samp_g = length(unique(id))) %>%
        group_by(catchReg, month, year) %>%
        mutate(samp_total = sum(samp_g)) %>%
        ungroup() %>%
        mutate(samp_g_ppn = samp_g / samp_total) %>%
        rename(stock = regName)
  
      raw_abund <- catch %>%
        group_by(catchReg, month, year) %>%
        summarize(sum_catch = sum(catch),
                  sum_effort = sum(boatDays),
                  agg_cpue = sum_catch / sum_effort) %>%
        ungroup() %>%
        left_join(., raw_prop, by = c("catchReg", "month", "year")) %>%
        mutate(catch_g = samp_g_ppn * sum_catch,
               cpue_g = samp_g_ppn * agg_cpue,
               catchReg = as.factor(catchReg)) %>%
        filter(!is.na(stock))
  
      list(pred_ci = pred_ci, raw_prop = raw_prop, raw_abund = raw_abund)
  })
  names(out_list) <- c("gsi", "cwt")
  
  # add unique identifiers to datasets and merge
  gsi_list <- map(out_list[["gsi"]], function(x) x %>% mutate(dat = "gsi"))
  cwt_list <- map(out_list[["cwt"]], function(x) x %>% mutate(dat = "cwt"))
  combo_list <- map2(gsi_list, cwt_list, rbind)
  
  saveRDS(combo_list, here::here("generatedData", "model_fits",
                                 "nbmult_cwt_gsi_comp.rds"))
}
```


```{r northern_prob_fig, echo=FALSE}
stk_subset <- c("FR-early", "FR-late", "PSD", "CR-tule", "CR-bright", "WCVI")
plot_list <- map(combo_list, function(x) 
  x %>% 
    filter(stock %in% stk_subset)
  )

comb_plot <- ggplot() +
  geom_pointrange(data = plot_list[["pred_ci"]], 
                  aes(x = month, y = pred_prob, ymin = pred_prob_low,
                      ymax = pred_prob_up, fill = dat), 
                  shape = 21, position = position_dodge(0.6)) +
  geom_point(data = plot_list[["raw_prop"]],
             aes(x = month, y = samp_g_ppn, fill = dat),
             shape = 21, alpha = 0.3, position = position_dodge(0.6)) +
  scale_color_viridis_d() +
  facet_wrap(stock~catchReg, nrow = length(stk_subset), scales = "free_y") +
  ggsidekick::theme_sleek()

pdf(here::here("figs", "model_pred", "both_nb_prop_pred.pdf"))
comb_plot
dev.off()
```
