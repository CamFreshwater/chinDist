---
title: "Predicted composition using CWT and TMB data"
output: html_document
---

```{r import_data, warning=FALSE, include=FALSE}
library(tidyverse)
library(TMB)
library(ggplot2)

# month range constrained to focal harvest period (reduces in-filling impacts)
month_range = c(seq(3, 6, by = 1), seq(8, 10, by = 1))

catch <- readRDS(here::here("data", "gsiCatchData", "commTroll",
                            "dailyCatch_WCVI.rds")) %>% 
  mutate(reg = factor(catchReg),
         area = as.factor(area),
         month_n = as.numeric(month),
         month = as.factor(month_n),
         year = as.factor(year)
  ) %>% 
  filter(!is.na(cpue),
         #first constrain by range
         month_n %in% c(month_range)
  ) %>% 
  droplevels() %>% 
  mutate(eff_z = as.numeric(scale(boatDays)),
         eff_z2 = eff_z^2
  ) %>% 
  arrange(catchReg, area, month)

comp_gsi <- readRDS(here::here("data", "gsiCatchData", "commTroll",
                           "pstAggRollUpCatchProb.RDS")) %>% 
  rename(regName = pstName) %>%
  #remove northern samples for now due to small sample size
  filter(!regName == "NBC_SEAK")
comp_cwt <- readRDS(here::here("data", "gsiCatchData", "commTroll",
                           "cwt_recovery_clean.rds")) %>% 
  rename(regName = pst_agg) %>% 
  filter(!regName == "NBC_SEAK")

source(here::here("R", "functions", "clean_composition_dat.R"))
comp_gsi_list <- clean_comp(comp_gsi, month_range = month_range, 
                         check_tables = TRUE)
comp_cwt_list <- clean_comp(comp_cwt, month_range = month_range, 
                         check_tables = TRUE)
comp_cwt_list$tables
```

Here are preliminary results of the model that uses commerical catch/effort and genetics data to predict stock-specific abundance of Chinook salmon off WCVI. Abundance is modeled using a negative binomial distribution with effort (boat days) included as an offset and stock composition is modeled using a multinomial distribution. We generate predictions for strata (catch region or statistical area and month or season) because finer scale spatio-temporal data are unavailable. Sampling (run) years are treated as random intercepts. General predictions are shown in wcvi_prelim_model_nb.Rmd, but the goal here is to contrast composition estimates derived from either GSI data or CWT returns  using the same model. For simplicity's sake we use non-expanded counts of CWT returns and a somewhat arbitrary stock assignment threshold of 75%.

The relative availability of samples is strongly seasonal and more variable for RMIS samples than GSI data; however the absolute number of samples is similar (Fig. 1). Note that these are transformed data where very rare stocks are infilled at low abunance in strata where they weren't necessarily observed (necessary for multinomial component of the model to converge; see wcvi_prelim_model_nb for details). 

```{r sample_dist, echo=FALSE, fig.cap = "Fig. 1 Monthly GSI and CWT samples available from WCVI troll fisheries.", warning=FALSE}
comp_g_infill <- comp_gsi_list$long_data %>% 
  group_by(catchReg, month, regName) %>% 
  summarize(n = length(unique(id)),
         dat = "GSI")

comp_c_infill <- comp_cwt_list$long_data %>% 
  group_by(catchReg, month, regName) %>% 
  summarize(n = length(unique(id)),
         dat = "CWT")

rbind(comp_c_infill, comp_g_infill) %>% 
  rename(Stock = regName) %>% 
  ggplot(.) +
  geom_bar(aes(x = month, y = n, fill = Stock), 
           stat = "identity") +
  labs(x = "Month", y = "Total Samples") +
  facet_grid(dat ~ catchReg) +
  scale_fill_viridis_d() +
  ggsidekick::theme_sleek()
```

The multinomial component of the model can be used to generate predictions of encounter probabilities for each strata, integrating over the random effects (i.e. interannual variability). By comparing predictions for the model parameterized with CWT vs. GSI data we can evaluate differences in the expected seasonal stock composition.

```{r run_models, message=FALSE, warning=FALSE, include=FALSE}
# run model with each set of genetics data if data are missing
combo_list <- readRDS(here::here("generatedData", "model_fits",
                                 "nbmult_cwt_gsi_comp.rds"))
if (!exists("combo_list")) {
  comp_list <- list(comp_gsi_list, comp_cwt_list)
  out_list <- map(comp_list, function(x) {
    comp_wide <- x[["data"]]
    comp_trim <- x[["long_data"]]
    
    fac_dat <- comp_wide %>%
      mutate(facs = as.factor(paste(as.character(catchReg),
                                    as.character(month), sep = "_")),
             facs = fct_relevel(facs, "NWVI_1", "NWVI_2", "NWVI_3", "NWVI_4",
                                "NWVI_5", "NWVI_6",  "NWVI_7", "NWVI_8", "NWVI_9",
                                "NWVI_10", "NWVI_11", "NWVI_12", "SWVI_1",
                                "SWVI_2", "SWVI_3",  "SWVI_4", "SWVI_5", "SWVI_6",
                                "SWVI_7", "SWVI_8",  "SWVI_9", "SWVI_10",
                                "SWVI_11", "SWVI_12"),
             facs_n = as.numeric(facs) - 1) %>%
      select(catchReg, month, facs, facs_n)
    fac_key_eff <- fac_dat %>%
      distinct() %>%
      arrange(facs_n) %>%
      mutate(eff_z = mean(catch$eff_z),
             eff_z2 = mean(catch$eff_z2))
  
    #prep data
    source(here::here("R", "functions", "prep_tmb_dat.R"))
    inputs <- tmb_dat(catch, comp_wide, fac_dat, fac_key = fac_key_eff,
                      mod = "nb")
  
    #run model
    compile(here::here("R", "southCoast", "tmb", "nb_multinomial_1re.cpp"))
    dyn.load(dynlib(here::here("R", "southCoast", "tmb",
                               "nb_multinomial_1re")))
    obj <- MakeADFun(inputs$data, inputs$parameters, random = c("z1_k", "z2_k"),
                     DLL = "nb_multinomial_1re")
  
    opt <- nlminb(obj$par, obj$fn, obj$gr)
    sdr <- sdreport(obj)
    ssdr <- summary(sdr)
  
    #generate predictions
    log_pred <- ssdr[rownames(ssdr) %in% "log_pred_abund", ]
    logit_probs <- ssdr[rownames(ssdr) %in% "logit_pred_prob", ]
    pred_abund <- ssdr[rownames(ssdr) %in% "pred_abund_mg", ]
  
    n_groups <- length(unique(comp_trim$regName))
    n_facs <- length(unique(fac_key_eff$facs_n))
  
    pred_ci <- data.frame(stock = as.character(rep(unique(comp_trim$regName),
                                                   each = n_facs)),
                          logit_prob_est = logit_probs[ , "Estimate"],
                          logit_prob_se =  logit_probs[ , "Std. Error"]) %>%
      mutate(facs_n = rep(fac_key_eff$facs_n, times = n_groups)) %>%
      mutate(pred_prob = plogis(logit_prob_est),
             pred_prob_low = plogis(logit_prob_est +
                                      (qnorm(0.025) * logit_prob_se)),
             pred_prob_up = plogis(logit_prob_est +
                                     (qnorm(0.975) * logit_prob_se)),
             abund_est = pred_abund[ , "Estimate"],
             abund_se =  pred_abund[ , "Std. Error"],
             abund_low = abund_est + (qnorm(0.025) * abund_se),
             abund_up = abund_est + (qnorm(0.975) * abund_se)) %>%
      left_join(., fac_key_eff, by = c("facs_n"))
  
      raw_prop <- comp_trim %>%
        group_by(catchReg, month, year, regName) %>%
        summarize(samp_g = length(unique(id))) %>%
        group_by(catchReg, month, year) %>%
        mutate(samp_total = sum(samp_g)) %>%
        ungroup() %>%
        mutate(samp_g_ppn = samp_g / samp_total) %>%
        rename(stock = regName)
  
      raw_abund <- catch %>%
        group_by(catchReg, month, year) %>%
        summarize(sum_catch = sum(catch),
                  sum_effort = sum(boatDays),
                  agg_cpue = sum_catch / sum_effort) %>%
        ungroup() %>%
        left_join(., raw_prop, by = c("catchReg", "month", "year")) %>%
        mutate(catch_g = samp_g_ppn * sum_catch,
               cpue_g = samp_g_ppn * agg_cpue,
               catchReg = as.factor(catchReg)) %>%
        filter(!is.na(stock))
  
      list(pred_ci = pred_ci, raw_prop = raw_prop, raw_abund = raw_abund)
  })
  names(out_list) <- c("gsi", "cwt")
  
  # add unique identifiers to datasets and merge
  gsi_list <- map(out_list[["gsi"]], function(x) x %>% mutate(dat = "gsi"))
  cwt_list <- map(out_list[["cwt"]], function(x) x %>% mutate(dat = "cwt"))
  combo_list <- map2(gsi_list, cwt_list, rbind)
  
  saveRDS(combo_list, here::here("generatedData", "model_fits",
                                 "nbmult_cwt_gsi_comp.rds"))
}
```

The effect of using GSI vs. CWT data to predict encounter probabilities varies among stocks and, to a lesser extent, among months, but is largely stable across regions (i.e. NW vs. SW Vancouver Island). For example, predicted encounter rates for Columbia River-brights (upriver fall run fish) and several less abundant stocks are similar (Fig. 2). Conversely, the GSI model predicts higher proportions of early run Fraser River in early summer, late run Fraser River in the fall, and Columbia River-tule (down river fall run) year round. These are offset by the CWT model predicting much higher proportions of Columbia River spring/summer run throughout the year. Other stocks exhibit less consistent patterns (e.g. Puget Sound), with one source or the other predicting greater abundance in a given strata.

```{r prob_fig, echo=FALSE, fig.height = 12.5, fig.width = 7, fig.cap = "Fig. 2 Model predicted mean encounter probabilities (solid points) and annual strata-specific observations (faded points). Stocks are ordered from dominant to subordinate contributors to catch composition. Whiskers represent 95% confidence intervals. Note that y-axis labels differ among stocks and that predictions for July are missing."}
plot_list <- combo_list
n_stk <- length(unique(plot_list[["pred_ci"]]$stock))

comb_plot <- ggplot() +
  geom_point(data = plot_list[["raw_prop"]] %>% 
                    mutate(stock = fct_reorder(stock, desc(samp_g_ppn))),
             aes(x = month, y = samp_g_ppn, fill = dat),
             shape = 21, alpha = 0.3, position = position_dodge(0.6)) +
  geom_pointrange(data = plot_list[["pred_ci"]] %>% 
                    mutate(stock = fct_reorder(stock, desc(pred_prob))), 
                  aes(x = month, y = pred_prob, ymin = pred_prob_low,
                      ymax = pred_prob_up, fill = dat), 
                  shape = 21, position = position_dodge(0.6)) +
  labs(x = "Month", y = "Predicted Encounter Probability") +
  scale_fill_viridis_d(option = "C", name = "Data Source") +
  facet_grid(stock~catchReg, scales = "free_y") +
  ggsidekick::theme_sleek() +
  theme(legend.position="top")
# pdf(here::here("figs", "model_pred", "both_nb_prop_pred.pdf"), height = 13,
#     width = 8)
comb_plot
# dev.off()
```

We can generate estimates of stock-specific abundance (standardized catch rates assuming constant effort) by multiplying aggregate catch rates by stock-specific encounter probabilities. Strong seasonal changes in catch rates resulted in estimates of stock-specific abundance diverging between the GSI and CWT-derived models. As a result, differences in catch appeared in several strata where differences in encounter probabilities were minor (Fig. 3). The CWT model predicted much greater abundances of Columbia River spring/summer run fish, particularly in late summer and early fall, and intermittently higher abundances of Puget Sound stocks. Conversely, the GSI model predicted much greater abundances of WCVI and Fraser River-early run stock early in the year, as well as Fraser River late and Columbia River-tule stocks later in the year.  

```{r abund_fig, echo=FALSE, fig.height = 12.5, fig.width = 7, fig.cap = "Fig. 3 Model predicted mean standardized catch (i.e. effort, boat days, fixed at the annual mean). Stocks are ordered from dominant to subordinate contributors to catch composition. Whiskers represent 95% confidence intervals. Note that y-axis labels differ among stocks and that predictions for July are missing."}
comb_plot2 <- ggplot() +
  geom_pointrange(data = plot_list[["pred_ci"]] %>% 
                    mutate(stock = fct_reorder(stock, desc(abund_est))), 
                  aes(x = month, y = abund_est, ymin = abund_low, 
                      ymax = abund_up, fill = dat), 
                  shape = 21, position = position_dodge(0.6)) +
  labs(x = "Month", y = "Predicted Catch") +
  scale_fill_viridis_d(option = "C", name = "Data Source") +
  facet_grid(stock~catchReg, scales = "free_y") +
  ggsidekick::theme_sleek() +
  theme(legend.position="top")

# pdf(here::here("figs", "model_pred", "both_nb_catch_pred.pdf"), height = 13,
#     width = 8)
comb_plot2
# dev.off()
```