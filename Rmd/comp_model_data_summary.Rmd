---
title: 'Adult Chinook Data Summary'
output: html_document
---

```{r loadData, include=FALSE}
library(tidyverse)
rec <- readRDS(here::here("data", "gsiCatchData", "rec", 
                          "recIndProbsLong.rds"))
comm <- readRDS(here::here("data", "gsiCatchData", "commTroll", 
                          "wcviIndProbsLong.rds"))
```

The goal of this analysis is to provide predictions of seasonal changes in stock-specific Chinook salmon abundance in various southern BC management area (Fig. 1). The model is uses catch/effort data from commercial and recreational fisheries to estimate aggregate Chinook salmon abundance, and composition data from subsets of the catch sampled for genetics. Spatial and temporal data are available at various scales and years depending on the fishery and data type (catch or composition; Table 1). Currently predictions are made at catch region and monthly scales. *Issue 1* Should commercial catch data be rolled up to generate predictions at same scale as recreational (results in substantial data loss)?

```{r map, echo=FALSE, fig.cap="Map of catch regions (colours) and PFMAs (shading)."}
pfma_map <- readRDS(here::here("generated_data", "pfma_map.rds"))
pfma_map
```

```{r pmTable, include=FALSE, results="asis"}
tab <- read.csv(here::here("data", "table_data.csv"), stringsAsFactors = F)

k <- knitr::kable(tab, format = "html", booktabs = TRUE, linesep = "",
                  caption = "Table 1. Available data.",
                  "latex") 
k <- kableExtra::kable_styling(k, font_size = 12)
k
```

Due to many strata being observed in only a subset of years (typically due to changes in management, Fig. 2), I have treated year as a random intercept. Predictions are currently made only using fixed effects and therefore do not account for interannual variability in relative abundance. While not ideal, I don't think it is surmountable given the available data and may not be relevant given the focus of the paper is on seasonal patterns in abundance, not accurate estimates of run sizes. *Issue 2* Should predictions account for interannual variability, e.g. by adding random noise from hyperdistribution for year effects? MOVE

```{r dataPatchiness, echo=FALSE, warning=FALSE, fig.cap="Figure 2. Availability of composition data within strata among years."}
f <- function(dat) {
  total <- length(unique(dat$year))
  dum <- expand.grid(region = unique(dat$region), month = seq(1, 12, by = 1)) 
  dat %>% 
    select(region, month = month_n, year) %>%
    distinct() %>% 
    group_by(region, month) %>% 
    tally() %>% 
    right_join(., dum, by = c("region", "month")) %>% 
    # replace_na(list(n = 0)) %>% 
    arrange(month) %>% 
    mutate(coverage = n / total,
           gear = unique(dat$gear))
}
tt <- map(list(rec, comm), f) %>% 
  bind_rows()

ggplot() +
  geom_tile(data = tt, aes(x = abbreviate(region, minlength = 4), 
                           y = as.factor(month), fill = coverage)) +
  ggsidekick::theme_sleek() +
  labs(x = "Catch Region", y = "Month") +
  scale_fill_viridis_c(option = "A", name = "Proportion Years\nWith Samples") +
  facet_wrap(~gear, scales = "free_x")
```

Catch data are available at a smaller spatial scale than composition data, but we know there are within region differences in catch rates. Therefore, I fit the abundance portion of the model at the scale of PFMAs, then generated summed predictions at the catch region level (Fig. 3). *Issue 3* However certain PFMAs are never fished in certain months, so the summed regional predictions are messy and will underestimate true abundance. One option is to crop the input data to only months where we have full coverage. Another is to generate predictions for an "average" stat area within a region by treating area as a random effect (not sure how to code this since levels aren't shared among regions). Similarly the commercial data are available at a finer scale (daily) than the rec data (monthly). If we fit the model to aggregated data, the predictions are more comparable, but the uncertaintly increases because there may be only 1 or 2 samples per strata (depending on the coverage among years).

```{r negBinPreds, echo=FALSE, fig.cap="Figure 3. Predicted aggregate abundance using commercial data."}
comm_abund <- readRDS(here::here("figs", "model_pred", "neg_bin_only",
                      "comm_negbin_predictions.RDS"))
p1 <- comm_abund[[1]] +
  labs(title = NULL, y = NULL, x = NULL) +
  theme(legend.position = "top") 
p2 <- comm_abund[[2]] +
  labs(title = NULL, y = NULL, x = NULL) +
  theme(legend.position = "none") 
p <- ggpubr::ggarrange(p1, p2, nrow = 2, heights = c(1.2, 0.88))
ggpubr::annotate_figure(p, 
                        left = ggpubr::text_grob("Predicted Mean Daily Catch",
                                                    rot = 90),
                        bottom = ggpubr::text_grob("Month"))
```

Since the uncertainty associated with parameter estimates for the multinomial fixed effects explode when there are zero observations of a stock in a given strata, pre-processing involves aggregating stock into higher level groups or strata, as well as infilling the dataset by adding small values. Here are predictions for higher-level regional aggregates (approximately equivalent to PST regional groupings). I've also generated predictions (not shown) for a "Canadian-centric" audience, where the focal units are management units and everything else is binned as "Other".
