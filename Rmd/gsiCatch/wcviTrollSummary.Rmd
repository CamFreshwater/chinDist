---
title: "WCVI Troll Catch"
output: html_document
---

```{r dataAndLibraries, include=FALSE}
library(tidyverse); library(ggplot2); library(ggpubr)
source(here::here("R", "functions", "pooledVar.R"))

fosCatch <- read.csv(here::here("data", "gsiCatchData", "commTroll",
                                "fosCatch.csv"))
catch <- read.csv(here::here("data", "gsiCatchData", "commTroll", 
                             "stockCatch_WCVI.csv"))
```

Tissues samples were collected from WCVI commercial troll vessels (`r min(catch$year)`-`r max(catch$year)`) and assigned to individual stocks using DFO genetics lab's coastwide baseline. Samples were collected in bulk vials (i.e. multiple muscle plugs per vial) and currently can be assigned to catch region (north or south westcoast VI) and month, but not to statistical area/troll zone or week/day (additional data could be interpolated using FOS database). 

Sampling effort was considerable and approximately proportional to catch. Sampling effort for stock ID (relative to catch) averaged `r mean(catch$samplePpn)` (range `r range(catch$samplePpn)`). 

```{r sampleSize}
catchAgg <- catch %>% 
  group_by(catchReg, month, year, labN) %>% 
  mutate(sumCatch = sum(estCatch)) %>% 
  select(catchReg, month, year, labN, sumEffort, sumCatch) %>% 
  mutate(cpue = sumCatch / sumEffort) %>% 
  distinct()

ggplot(catchAgg) +
  geom_bar(aes(x = as.factor(month), y = labN, fill = catchReg), 
       stat = "identity") +
    scale_fill_viridis_d() +
  labs(x = "", y = "GSI Samples", fill = "Catch Region") +
  facet_wrap(~year)
```

Although the west coast troll fishery currently occurs in August and early September (constrained by interior Fraser coho initially, then steelhead), until recently effort peaked in May. Conversely CPUE, ignoring stock composition, peaked later in summer (July/August) depending on catch region.

```{r plotEffort, warning=FALSE}
eff <- ggplot(catchAgg, aes(x = as.factor(month), y = sumEffort, 
                            fill = catchReg)) +
  scale_fill_viridis_d() +
  geom_boxplot() +
  labs(x = "", y = "Monthly Effort (boat days)", color = "Catch Region")
cpue <- ggplot(catchAgg, aes(x = as.factor(month), y = cpue, 
                             fill = catchReg)) +
  scale_fill_viridis_d() +
  geom_boxplot() +
  labs(x = "Month", y = "CPUE (Chinook per boat day)", fill = "Catch Region")
ggarrange(eff, cpue, ncol = 1, nrow = 2, common.legend = TRUE)
```

Although samples cannot yet be attributed to specific stat areas, catches can. Majority of effort in offshore areas (catch trends, not shown, are similar). Areas 125 and 126 in the north, 123 in the south. Note, however, that 123 effort has declined substantially in recent years.

```{r saCatch, warning=FALSE}
ggplot(fosCatch, aes(x = as.factor(FISHING.MONTH), y = VESSELS_OP, 
                             fill = as.factor(MGMT_AREA))) +
  geom_boxplot() +
  labs(x = "Month", y = "Effort (boat days)", fill = "Management Area") +
  scale_fill_viridis_d() +
  facet_wrap(~CATCH_REGION)
```

Relative catch contributions depend on how the data are aggregated across time and rolled up regionally. For example absolute catches are, on average, dominated by Columbia River fish in the north and Columbia plus Puget Sound fish in the south. 

```{r aggComp, echo=FALSE}
reg3Catch <- catch %>% 
  group_by(catchReg, month, year, Region3Name) %>% 
  summarize(sumCatch = sum(estCatch)) %>%
  group_by(catchReg, month, Region3Name) %>% 
  summarize(meanCatch = mean(sumCatch, na.rm = TRUE))

ggplot(reg3Catch) +
  geom_bar(aes(x = as.factor(month), y = meanCatch, fill = Region3Name),
       stat = "identity") +
    scale_fill_viridis_d() +
  labs(x = "", y = "Catch", fill = "Region of Origin") +
  facet_wrap(~catchReg)
```

These patterns can be visualized more clearly with proportional catches. Again Columbia River and Puget Sound fish are the dominant contributor, however Fraser abundance peaks again in August.

```{r propAggComp, echo = FALSE}
reg3Prop <- reg3Catch %>% 
  group_by(catchReg, month) %>% 
  summarize(totalCatch = sum(meanCatch)) %>% 
  left_join(reg3Catch, ., by = c("catchReg", "month")) %>% 
  mutate(propCatch = meanCatch / totalCatch)

ggplot(reg3Prop) +
  geom_bar(aes(x = as.factor(month), y = propCatch, fill = Region3Name), 
       stat = "identity") +
    scale_fill_viridis_d() +
  labs(x = "", y = "Proportional Catch", fill = "Region of Origin") +
  facet_wrap(~catchReg)
```

Yet another way to visualize these data are to focus on how the seasonal abundance of a specific aggregate changes through time. Here we see that west coast Vancouver Island stocks tend to peak relatively early and Fraser River stocks relatively late.

```{r propTS, echo = FALSE}
reg3Month <- catch %>% 
  group_by(catchReg, Region3Name, month, year) %>%
  summarize(monthlyCatch = sum(estCatch))
reg3TS <- catch %>% 
  group_by(catchReg, Region3Name, year) %>% 
  summarize(annualCatch = sum(estCatch)) %>% 
  left_join(reg3Month, ., by = c("catchReg", "Region3Name", "year")) %>% 
  filter(Region3Name %in% c("Fraser River", "WCVI", "Columbia", 
                            "Puget Sound")) %>% 
  mutate(propCatch = monthlyCatch / annualCatch)

ggplot(reg3TS) +
  geom_boxplot(aes(x = as.factor(month), y = propCatch, fill = Region3Name)) +
  scale_fill_viridis_d() +
  labs(x = "", y = "Proportional Catch", fill = "Region of Origin") +
  facet_wrap(~catchReg)
```