---
title: "WCVI Troll Catch"
output: pdf_document
---

```{r dataAndLibraries, include=FALSE}
library(tidyverse); library(ggplot2); library(ggpubr)
source(here::here("R", "functions", "pooledVar.R"))

fosCatch <- read.csv(here::here("data", "gsiCatchData", "commTroll",
                                "fosCatch.csv"))
catch <- read.csv(here::here("data", "gsiCatchData", "commTroll", 
                             "stockCatch_WCVI.csv"))
```

Tissues samples were collected from WCVI commercial troll vessels (`r min(catch$year)`-`r max(catch$year)`) and assigned to individual stocks using DFO genetics lab's coastwide baseline. Samples were collected in bulk vials (i.e. multiple muscle plugs per vial) and currently can be assigned to catch region (north or south westcoast VI) and month, but not to statistical area/troll zone or week/day (additional data could be interpolated using FOS database). 

Sampling effort was considerable and approximately proportional to catch. Sampling effort for stock ID (relative to catch) averaged `r mean(catch$samplePpn, na.rm = T)` (range `r range(catch$samplePpn, na.rm = T)`). 

```{r sampleSize, include=FALSE}
catchAgg <- catch %>% 
  group_by(catchReg, month, year, labN) %>% 
  mutate(sumCatch = sum(estCatch)) %>% 
  select(catchReg, month, year, labN, sumEffort, sumCatch) %>% 
  mutate(cpue = sumCatch / sumEffort) %>% 
  distinct()

ggplot(catchAgg) +
  geom_bar(aes(x = as.factor(month), y = labN, fill = catchReg), 
       stat = "identity") +
    scale_fill_viridis_d() +
  labs(x = "", y = "GSI Samples", fill = "Catch Region") +
  facet_wrap(~year) +
  samSim::theme_sleekX()
```

Although the west coast troll fishery currently occurs in August and early September (constrained by interior Fraser coho initially, then steelhead), until recently effort peaked in May. Conversely CPUE, ignoring stock composition, peaked later in summer (July/August) depending on catch region.

```{r plotEffort, warning=FALSE, include=FALSE}
eff <- ggplot(catchAgg, aes(x = as.factor(month), y = sumEffort, 
                            fill = catchReg)) +
  scale_fill_viridis_d() +
  geom_boxplot() +
  labs(x = "", y = "Monthly Effort (boat days)", color = "Catch Region") +
  samSim::theme_sleekX()
cpue <- ggplot(catchAgg, aes(x = as.factor(month), y = cpue, 
                             fill = catchReg)) +
  scale_fill_viridis_d() +
  geom_boxplot() +
  labs(x = "Month", y = "CPUE (Chinook per boat day)", fill = "Catch Region") +
  samSim::theme_sleekX()
ggarrange(eff, cpue, ncol = 1, nrow = 2, common.legend = TRUE)
```

Although samples cannot yet be attributed to specific stat areas, catches can. Majority of effort in offshore areas (catch trends, not shown, are similar). Areas 125 and 126 in the north, 123 in the south. Note, however, that 123 effort has declined substantially in recent years and areas 24-27 are not shown here due to low effort.

```{r saCatch, warning=FALSE}
dum <- fosCatch %>% 
  filter(MGMT_AREA %in% c("23", "123", "124", "125", "126", "127"))
ggplot(dum, aes(x = as.factor(FISHING.MONTH), y = VESSELS_OP, 
                             fill = as.factor(MGMT_AREA))) +
  geom_boxplot() +
  labs(x = "Month", y = "Effort (boat days)", fill = "Management Area") +
  scale_fill_viridis_d() +
  facet_wrap(~MGMT_AREA, scales = "free_y") +
  samSim::theme_sleekX()
```

Relative catch contributions depend on how the data are aggregated across time and rolled up regionally. For example absolute catches are, on average, dominated by Columbia River fish in the north and Columbia plus Puget Sound fish in the south. 

```{r aggComp, echo=FALSE}
reg3Catch <- catch %>% 
  group_by(catchReg, month, year, Region3Name) %>% 
  summarize(sumCatch = sum(estCatch)) %>%
  group_by(catchReg, month, Region3Name) %>% 
  summarize(meanCatch = mean(sumCatch, na.rm = TRUE))

ggplot(reg3Catch) +
  geom_bar(aes(x = as.factor(month), y = meanCatch, fill = Region3Name),
       stat = "identity") +
    scale_fill_viridis_d() +
  labs(x = "", y = "Catch", fill = "Region of Origin") +
  facet_wrap(~catchReg) + 
  samSim::theme_sleekX()
```

These patterns can be visualized more clearly with proportional catches (i.e. the relative contribution of each stock to a given month's catch). Again Columbia River and Puget Sound fish are the dominant contributor, however Fraser abundance is clearly significant in August in the south.

```{r propAggComp, echo = FALSE}
reg3Prop <- reg3Catch %>% 
  group_by(catchReg, month) %>% 
  summarize(totalCatch = sum(meanCatch)) %>% 
  left_join(reg3Catch, ., by = c("catchReg", "month")) %>% 
  mutate(propCatch = meanCatch / totalCatch)

ggplot(reg3Prop) +
  geom_bar(aes(x = as.factor(month), y = propCatch, fill = Region3Name), 
       stat = "identity") +
    scale_fill_viridis_d() +
  labs(x = "", y = "Proportional Catch", fill = "Region of Origin") +
  facet_wrap(~catchReg) +
  samSim::theme_sleekX()
```

Yet another way to visualize these data are to focus on how the seasonal abundance of a specific aggregate changes through time. Here we see that west coast Vancouver Island stocks tend to peak relatively early and Fraser River stocks relatively late.

```{r propTS, echo = FALSE}
reg3Month <- catch %>% 
  group_by(catchReg, Region3Name, month, year) %>%
  summarize(monthlyCatch = sum(estCatch))
reg3TS <- catch %>% 
  group_by(catchReg, Region3Name, year) %>% 
  summarize(annualCatch = sum(estCatch)) %>% 
  left_join(reg3Month, ., by = c("catchReg", "Region3Name", "year")) %>% 
  filter(Region3Name %in% c("Fraser River", "WCVI", "Columbia", 
                            "Puget Sound"),
         catchReg == "SWVI") %>% 
  mutate(propCatch = monthlyCatch / annualCatch)

ggplot(reg3TS) +
  geom_boxplot(aes(x = as.factor(month), y = propCatch, fill = Region3Name)) +
  scale_fill_viridis_d() +
  labs(x = "", y = "Proportional Catch", fill = "Region of Origin") +
  facet_wrap(~Region3Name)
```

Ignoring interannual variation (for now) we can also look at the cumulative proportion of the catch through the calendar year. Note that it may be reasonable to consider alternative time frames such as having the year "end" when the last spawner should have passed through an area. 

```{r cumSum, echo = FALSE}
reg3CumSum <- reg3Month  %>% 
  group_by(catchReg, Region3Name, month) %>% 
  summarize(meanMonthC = mean(monthlyCatch, na.rm = T)) %>% 
  group_by(catchReg, Region3Name) %>% 
  mutate(cumCatch = cumsum(meanMonthC)) %>% 
  filter(Region3Name %in% c("Fraser River", "WCVI", "Columbia", 
                            "Puget Sound"),
         catchReg == "SWVI")
  
ggplot(reg3CumSum) +
  geom_line(aes(x = month, y = cumCatch, colour = Region3Name)) +
  scale_fill_viridis_d() +
  labs(x = "", y = "Cumulative Catch", fill = "Region of Origin") +
  facet_wrap(~Region3Name)
```

May be important to account for stock-specific variation within a region. As an example focus on individual stocks within Fraser. There are relatively large contributions of South Thompson fish throughout the spring and summer, as well as noticeable contributions of Upper Fraser fish during the summer, but only in NWVI catches. In SWVI almost exclusively dominated by fall Fraser fish.

```{r fraser, echo = FALSE}
frStocks <- unique(catch$Region1Name)[1:6]
frCatch <- catch %>% 
  filter(Region1Name %in% frStocks) %>% 
  group_by(catchReg, Region1Name, month, year) %>% 
  summarize(monthlyCatch = sum(estCatch)) %>% 
  group_by(catchReg, Region1Name, month) %>% 
  summarize(meanCatch = mean(monthlyCatch, na.rm = TRUE))
frProp <- frCatch %>% 
  group_by(catchReg, month) %>% 
  summarize(totalCatch = sum(meanCatch)) %>% 
  left_join(frCatch, ., by = c("catchReg", "month")) %>% 
  mutate(propCatch = meanCatch / totalCatch)

ggplot(frProp) +
  geom_bar(aes(x = as.factor(month), y = propCatch, fill = Region1Name), 
       stat = "identity") +
    scale_fill_viridis_d() +
  labs(x = "", y = "Proportional Catch", fill = "Management Unit") +
  facet_wrap(~catchReg)
```

Plot cumulative catch, again ignoring interannual variablity, to provide a coarse index of passage through the fishery.

```{r frPropTS, echo = FALSE}
frMonth <- catch %>% 
  filter(Region1Name %in% frStocks) %>% 
  group_by(catchReg, Region1Name, month, year) %>%
  summarize(monthlyCatch = sum(estCatch, na.rm = T))
frTS <- catch %>% 
  filter(Region1Name %in% frStocks) %>% 
  group_by(catchReg, Region1Name, year) %>% 
  summarize(annualCatch = sum(estCatch, na.rm = T)) %>% 
  left_join(frMonth, ., by = c("catchReg", "Region1Name", "year")) %>% 
  mutate(propCatch = monthlyCatch / annualCatch)

ggplot(frTS %>% filter(catchReg == "NWVI")) +
  geom_boxplot(aes(x = as.factor(month), y = propCatch, fill = Region1Name)) +
  scale_fill_viridis_d() +
  labs(x = "", y = "Proportional Catch", fill = "Region of Origin") +
  facet_wrap(~Region1Name)
```

```{r frCumSum, echo = FALSE}
frCumCatch <- frTS %>% 
  group_by(month, catchReg, Region1Name) %>% 
  summarize(meanMonthly = mean(monthlyCatch, na.rm = T),
            meanAnnual = mean(annualCatch, na.rm = T)) %>% 
  mutate(meanPropCatch = meanMonthly / meanAnnual) %>% 
  group_by(catchReg, Region1Name) %>% 
  mutate(cumCatch = cumsum(meanMonthly), 
         ppnCum = cumsum(meanPropCatch))

ggplot(frCumCatch) +
  geom_line(aes(x = month, y = ppnCum, colour = Region1Name)) +
  scale_colour_viridis_d() +
  labs(x = "", y = "Cumulative Catch", fill = "Region of Origin") +
  facet_wrap(~catchReg)
```
