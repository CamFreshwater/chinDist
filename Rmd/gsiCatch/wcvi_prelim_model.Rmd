---
title: "Initial Westcoast GSI Predictions"
output: word_document
---

```{r initial_data, include=FALSE}
library(tidyverse)

plot_list <- readRDS(here::here("generatedData", "model_fits",
                                "frB_plot_list.RDS"))

# reorder factor levels
stk_plot_list <- map(plot_list[2:4], function(x) 
  x %>% 
    mutate(stock = fct_relevel(stock, "FR 1.x", "Thomp. 1.x", "FR-Fall", 
                               "South Thomp.", "Other"))
  )
```

Here we present preliminary results of a model that uses existing catch/effort and genetics data to predict the abundance of stock groups of interest at relatively fine ecological, spatial, and temporal scales. The basic premise is to simultaneously estimate abundance and stock composition by integrating two models, which allows uncertainty to be between the two estimates. By using a hierarchical model that treats sampling year as a random intercept, we can generate predictions of abundance in an "average" year, while accounting for interannual changes in sampling effort or fishery closures.

The scale at which spatio-temporal predictions can be made is a function of data availability because the stock composition component of the model requires non-zero data (i.e. a stock can be at very low abundance but cannot be absent). This issue can be resolved by aggregating stocks, aggregating time/area strata, or infilling the dataset by adding small values to a subset of strata. As more data are added to the model, this will becomes less of an issue. The model can be run with any combination of stocks of interest, provided sufficient data are available. There is generally a tradeoff between stock and spatial resolution so that with larger aggregates we can make stat area predictions, but with smaller aggregates we are constrained to NW vs. SW VI.  

Here we show preliminary predictions of abundance (CPUE; catch per boat day) and stock composition for four different pooled Fraser River stock aggregates: Fraser River yearlings (predominantly lower Fraser spring/summer runs, as well as middle and upper Fraser fish), Thompson yearlings, Fraser River subyearlings (predominantly lower Fraser River fall run), and South Thompson. All non-Fraser fish are binned as "Other". We constrained the predictions to March through October due to very low sample sizes of yearling fish late in the year.

Red points represent median predictions from the model with 95% confidence intervals. The grey points represent aggregated monthly estimates of stock composition from the raw GSI data with each point representing a single year. The predictions generally include the raw estimates. Discrepancies arise due to small sample sizes in certain years, which are downweighted by the model because it is fit to individual data, and because information is pooled among the NWVI and SWVI regions, pulling estimates towards mean values. Predictions in October are particularly uncertain because few yearling fish are encountered.

```{r plot_comp, echo=FALSE, fig.height = 5, fig.width = 3.5}
n_groups <- length(unique(stk_plot_list$pred_ci$stock))
ggplot() +
  geom_pointrange(data = stk_plot_list$pred_ci,
                  aes(x = month, y = pred_prob, ymin = pred_prob_low,
                      ymax = pred_prob_up),
                  col = "red") +
  geom_point(data = stk_plot_list$raw_prop,
             aes(x = month, y = samp_g_ppn),
             alpha = 0.4) +
  facet_wrap(stock ~ catchReg, nrow = n_groups, scales = "free_y") +
  ggsidekick::theme_sleek() +
  labs(y = "Predicted Encounter Probability", x = "Month") +
  theme(text = element_text(size = 8),
        axis.text = element_text(size = 7))
```

By combining estimates of aggregate abundance (not shown) with the probability of encountering individual stocks we can generate estimates of stock-specific abundance. Here raw data represent monthly averaged catch per unit effort multiplied by the proportion of the catch belonging to a given stock, red points represent median estimates as above, but note that the scale of the y-axes changes across panels. Future model versions will differ by modeling catch directly and including effort as a covariate, rather than CPUE. 

```{r plot_abund, echo=FALSE, fig.height = 5, fig.width = 3.5}
pred_ci_trim <- stk_plot_list[["pred_ci"]] %>%
  mutate(abund_low = case_when(
    abund_low < 0 ~ 0,
    TRUE ~ abund_low
  ))

ggplot() +
  geom_pointrange(data = pred_ci_trim,
                  aes(x = month, y = abund_est, ymin = abund_low,
                      ymax = abund_up),
                  col = "red") +
    geom_point(data = stk_plot_list[["raw_abund"]],
             aes(x = month, y = cpue_g), alpha = 0.4) +
  facet_wrap(stock ~ catchReg, nrow = n_groups, scales = "free_y") +
  ggsidekick::theme_sleek() +
  labs(y = "Predicted CPUE\n(individuals per boat day)", x = "Month") +
  theme(text = element_text(size = 8),
        axis.text = element_text(size = 7))
```

Next steps in the modeling process include:

1. _Troubleshoot data_. Some commercial data appears to be missing (e.g. no catch/effort records for SWVI in July even though GSI samples exist).

2. _Incorporating recreational data from WCVI and the Strait of Georgia_. Additional data will increase the precision of the estimates. These can be added at similar spatial/temporal scales to the commercial data or modeled separately to generate fine-scale predictions (e.g. heat maps) when daily lat/longs are available.

3. _Parameterize model with CWT data_. A comparison with predictions from an equivalent CWT-based model will provide an estimate of potential bias introduced by using indicator stocks.
